![[Pasted image 20250520141808.png]]

![[Pasted image 20250604165013.png]]



### 1. ëª¨ë¸
---
``` python
import serial
import time
import numpy as np
from your_rl_model import sac_model  # ì´ë¯¸ í›ˆë ¨ëœ SAC ëª¨ë¸ ê°€ì ¸ì˜¤ê¸°'

# ì‹œë¦¬ì–¼ í¬íŠ¸ ì—°ê²° (í¬íŠ¸ ì´ë¦„ì€ í™˜ê²½ì— ë”°ë¼ ë³€ê²½)
ser = serial.Serial('COM15', 9600)
time.sleep(2)  # ì•„ë‘ì´ë…¸ ì´ˆê¸°í™” ëŒ€ê¸°

def send_action(action):
    """
    action: np.array of shape (2,) with values in [-1, 1]
    """
    # ë²”ìœ„ [-1, 1] â†’ [-255, 255]ë¡œ ë³€í™˜ í›„ ì •ìˆ˜í™”
    pwm_x = int(np.clip(action[0], -1, 1) * 255)
    pwm_y = int(np.clip(action[1], -1, 1) * 255)

    # ë¬¸ìì—´ë¡œ í¬ë§·íŒ… í›„ ì „ì†¡ (ì˜ˆ: "123,-45\n")
    msg = f"{pwm_x},{pwm_y}\n"
    ser.write(msg.encode())

# ì˜ˆì‹œ ì‹¤í–‰
while True:
    # ì˜ˆì‹œ ìƒíƒœ (ì‹¤ì œ ì‹œìŠ¤í…œì—ì„  roll/pitch ë“± ì¸¡ì •ê°’)
    state = get_current_state()  # ì‚¬ìš©ì êµ¬í˜„ í•„ìš”
    action = sac_model.select_action(state)
    send_action(action)
    time.sleep(0.2)  # 200ms ì£¼ê¸°

```

``` cpp
#include <Arduino.h>

int motor_x_pwm = 5;
int motor_x_dir1 = 6;
int motor_x_dir2 = 7;

int motor_y_pwm = 9;
int motor_y_dir1 = 10;
int motor_y_dir2 = 11;

void setup() {
  Serial.begin(9600);
  pinMode(motor_x_pwm, OUTPUT);
  pinMode(motor_x_dir1, OUTPUT);
  pinMode(motor_x_dir2, OUTPUT);
  pinMode(motor_y_pwm, OUTPUT);
  pinMode(motor_y_dir1, OUTPUT);
  pinMode(motor_y_dir2, OUTPUT);
}

void loop() {
  if (Serial.available()) {
    String input = Serial.readStringUntil('\n'); // "123,-45"
    int commaIndex = input.indexOf(',');
    if (commaIndex > 0) {
      int pwm_x = input.substring(0, commaIndex).toInt();
      int pwm_y = input.substring(commaIndex + 1).toInt();

      // xì¶• ëª¨í„° ì œì–´
      if (pwm_x >= 0) {
        digitalWrite(motor_x_dir1, LOW);
        digitalWrite(motor_x_dir2, HIGH);
        analogWrite(motor_x_pwm, pwm_x);
      } else {
        digitalWrite(motor_x_dir1, HIGH);
        digitalWrite(motor_x_dir2, LOW);
        analogWrite(motor_x_pwm, -pwm_x);
      }

      // yì¶• ëª¨í„° ì œì–´
      if (pwm_y >= 0) {
        digitalWrite(motor_y_dir1, LOW);
        digitalWrite(motor_y_dir2, HIGH);
        analogWrite(motor_y_pwm, pwm_y);
      } else {
        digitalWrite(motor_y_dir1, HIGH);
        digitalWrite(motor_y_dir2, LOW);
        analogWrite(motor_y_pwm, -pwm_y);
      }
    }
  }
}

```


ìƒíƒœ ë²¡í„°
``` python
state = [roll, pitch, gyro_x, gyro_y]  # ì´ 4ì°¨ì›
```

``` cpp
#include <Wire.h>
#include <MPU6050.h>

MPU6050 imu;

float roll = 0, pitch = 0;
float gyro_x = 0, gyro_y = 0;

void setup() {
  Serial.begin(9600);
  Wire.begin();
  imu.initialize();

  if (!imu.testConnection()) {
    Serial.println("MPU6050 ì—°ê²° ì‹¤íŒ¨!");
    while (1);
  }
}

void loop() {
  imu.getMotion6(&ax, &ay, &az, &gx, &gy, &gz);

  // ìì´ë¡œê°’ì„ ê°ì†ë„ë¡œ ë³€í™˜ (ë‹¨ìœ„: deg/s)
  gyro_x = gx / 131.0;
  gyro_y = gy / 131.0;

  // roll, pitch ê³„ì‚° (ë‹¨ìˆœ ê°€ì†ë„ ê¸°ë°˜)
  roll = atan2(ay, az) * 180 / PI;
  pitch = atan2(-ax, sqrt(ay * ay + az * az)) * 180 / PI;

  // ì‹œë¦¬ì–¼ë¡œ ìƒíƒœ ì „ì†¡: ì˜ˆ) "roll,pitch,gyro_x,gyro_y\n"
  Serial.print(roll); Serial.print(",");
  Serial.print(pitch); Serial.print(",");
  Serial.print(gyro_x); Serial.print(",");
  Serial.println(gyro_y);

  delay(50);  // 20Hz ì£¼ê¸°
}

```

``` python
import serial

ser = serial.Serial('COM15', 9600)

def get_state():
    line = ser.readline().decode().strip()  # "3.4,-1.2,0.05,-0.10"
    vals = list(map(float, line.split(",")))
    return vals  # [roll, pitch, gyro_x, gyro_y]

```

ë³´ìƒ í•¨ìˆ˜

``` python
def compute_reward(state):
    roll, pitch, gyro_x, gyro_y = state

    # ê°ë„ ë³´ìƒ: ìˆ˜í‰ì—ì„œ ë©€ì–´ì§ˆìˆ˜ë¡ íŒ¨ë„í‹°
    angle_penalty = roll**2 + pitch**2

    # ê°ì†ë„ ë³´ìƒ: ì§„ë™ì´ ì‹¬í•˜ë©´ ê³µì´ íƒˆì¶œ ê°€ëŠ¥
    gyro_penalty = 0.01 * (gyro_x**2 + gyro_y**2)

    # ì´ ë³´ìƒì€ ìŒì˜ íŒ¨ë„í‹°
    reward = - (angle_penalty + gyro_penalty)
    return reward
```

``` python
import serial
import time
import numpy as np

# ğŸ”§ ì•„ë‘ì´ë…¸ ì—°ê²° ì„¤ì • (í¬íŠ¸ëŠ” ì‹œìŠ¤í…œì— ë§ê²Œ ìˆ˜ì •)
ser = serial.Serial('COM15', 9600, timeout=1)
time.sleep(2)  # ì•„ë‘ì´ë…¸ ì´ˆê¸°í™” ëŒ€ê¸°

# ğŸ’¡ SAC ëª¨ë¸ ë¡œë”© (ì‚¬ìš©ìê°€ êµ¬í˜„í•œ SAC í´ë˜ìŠ¤ ì‚¬ìš©)
from your_sac_module import SACModel  # ì‚¬ìš©ìê°€ ë§Œë“  SAC ëª¨ë¸ import
sac_model = SACModel.load("your_model_path.pt")  # ëª¨ë¸ ë¡œë“œ

# ìƒíƒœ ì½ê¸° í•¨ìˆ˜ (roll, pitch, gyro_x, gyro_y)
def get_state_from_serial():
    try:
        line = ser.readline().decode().strip()  # ì˜ˆ: "State: 2.1,-0.8,0.2,-0.1"
        if not line.startswith("State:"):
            return None
        data = line.replace("State:", "").strip()
        roll, pitch, gyro_x, gyro_y = map(float, data.split(","))
        return np.array([roll, pitch, gyro_x, gyro_y], dtype=np.float32)
    except:
        return None

# action â†’ ì‹œë¦¬ì–¼ ì „ì†¡ í•¨ìˆ˜
def send_action(action):
    # [-1, 1] â†’ [-255, 255] ë²”ìœ„ë¡œ ìŠ¤ì¼€ì¼ë§
    pwm_x = int(np.clip(action[0], -1, 1) * 255)
    pwm_y = int(np.clip(action[1], -1, 1) * 255)
    msg = f"{pwm_x},{pwm_y}\n"
    ser.write(msg.encode())

# ğŸ” ì œì–´ ë£¨í”„
while True:
    state = get_state_from_serial()
    if state is None:
        continue  # ì˜ëª»ëœ ìƒíƒœëŠ” ë¬´ì‹œ

    # ëª¨ë¸ë¡œë¶€í„° í–‰ë™ ì¶”ë¡ 
    action = sac_model.select_action(state)  # shape: (2,) âˆˆ [-1, 1]

    # ì•„ë‘ì´ë…¸ë¡œ ì „ì†¡
    send_action(action)

    time.sleep(0.05)  # 50ms ì£¼ê¸° (20Hz)

```